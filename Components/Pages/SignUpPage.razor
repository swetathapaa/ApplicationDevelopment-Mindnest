@page "/signup"
@inject NavigationManager Navigation
@inject MindNestApp.Services.SQLiteService Db
@inject AuthStateService Auth

<div class="auth-container">

    <!-- LEFT VISUAL -->
    <div class="auth-visual">
        <div class="bubble-wrapper">
            <div class="bubble-main-circle">
                <div class="circle-text">
                    ðŸŒ¿<br />
                    Start your journey<br />
                    Creative private space<br />
                    for self-reflection
                </div>
            </div>
            <div class="bubble-transparent top"></div>
            <div class="bubble-transparent bottom"></div>
        </div>
    </div>

    <!-- RIGHT FORM -->
    <div class="auth-form">
        <div class="form-card">
            <h2>Sign Up</h2>

            @if (!string.IsNullOrEmpty(message))
            {
                <p class="error">@message</p>
            }

            <div class="form-group">
                <input class="form-input" placeholder="Full Name" @bind="fullName" />
            </div>

            <div class="form-group">
                <input class="form-input" placeholder="Email" @bind="email" />
            </div>

            <div class="form-group">
                <input class="form-input" type="password" placeholder="Password" @bind="password" />
            </div>

            <div class="form-group">
                <input class="form-input" type="password" placeholder="Confirm Password" @bind="confirmPassword" />
            </div>

            <div class="form-group">
                <input class="form-input" placeholder="Phone Number" @bind="phoneNumber" />
            </div>

            <!-- Date of Birth with proper rectangle styling -->
            <div class="form-group">
                <input class="form-input date-input" type="date" @bind="dateOfBirth" />



            </div>



            <div class="form-group">
                <select class="form-select" @bind="gender">
                    <option value="">Select Gender</option>
                    <option>Male</option>
                    <option>Female</option>
                    <option>Other</option>
                </select>
            </div>

            <!-- Terms & Conditions Toggle -->
            <div class="terms-container">
                <div class="agree-toggle @(agreeToTerms ? "agreed" : "")" @onclick="() => agreeToTerms = !agreeToTerms">
                    @(agreeToTerms ? "âœ“ Agreed" : "Agree")
                </div>
                <span>I agree to the <span class="terms-link">Terms & Conditions</span></span>

                <div class="terms-tooltip">
                    By signing up, you agree to our full terms of service and privacy policy.
                </div>
            </div>

            <!-- Create Account Button -->
            <button class="btn-primary" @onclick="Signup">Create Account</button>

            <div class="switch">
                Already have an account? <span @onclick="GoToLogin">Login</span>
            </div>
        </div>
    </div>
</div>

@code {
    private string fullName = "";
    private string email = "";
    private string password = "";
    private string confirmPassword = "";
    private string phoneNumber = "";
    private string gender = "";
    private DateTime? dateOfBirth;
    private bool agreeToTerms = false;
    private string message = "";

    private async Task Signup()
    {
        message = "";

        // VALIDATIONS
        if (string.IsNullOrWhiteSpace(fullName))
        {
            message = "Full name is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(email))
        {
            message = "Email is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(password))
        {
            message = "Password is required.";
            return;
        }

        if (password != confirmPassword)
        {
            message = "Passwords do not match.";
            return;
        }

        if (string.IsNullOrWhiteSpace(phoneNumber))
        {
            message = "Phone number is required.";
            return;
        }

        if (dateOfBirth == null)
        {
            message = "Please select your date of birth.";
            return;
        }

        if (string.IsNullOrWhiteSpace(gender))
        {
            message = "Please select your gender.";
            return;
        }

        if (!agreeToTerms)
        {
            message = "You must agree to the Terms & Conditions.";
            return;
        }

        var existingUser = await Db.GetUserByEmailAsync(email);
        if (existingUser != null)
        {
            message = "An account with this email already exists.";
            return;
        }

        // CREATE USER
        await Db.AddUserAsync(new MindNestApp.Models.User
        {
            FullName = fullName,
            Email = email,
            Password = password,
            PhoneNumber = phoneNumber,
            DateOfBirth = dateOfBirth.Value,
            Gender = gender
        });

        // CONFIRMATION MESSAGE
        message = "Account created successfully! You will be redirected to login...";
        StateHasChanged();

        await Task.Delay(2000); // wait 2 seconds so user can see message
        Navigation.NavigateTo("/login", true);
    }

    void GoToLogin() => Navigation.NavigateTo("/login");
}
