@page "/signup"
@inject NavigationManager Navigation
@inject MindNestApp.Services.SQLiteService Db
@inject AuthStateService Auth

<div class="auth-container">

    <!-- LEFT DECORATIVE SIDE -->
    <div class="auth-visual">
        <div class="bubble-wrapper">
            <div class="bubble-main">
                <div>
                    <h2>Hello There!</h2>
                    <p>Start your mindful journey<br />by signing up</p>
                </div>
            </div>
            <div class="bubble-small bubble-top-left"></div>
            <div class="bubble-small bubble-bottom-right"></div>
        </div>
    </div>

    <!-- RIGHT FORM -->
    <div class="auth-form">
        <div class="form-card">
            <h2>Sign Up</h2>

            <input placeholder="Full Name" @bind="fullName" />
            <input placeholder="Email" @bind="email" />
            <input type="password" placeholder="Password" @bind="password" />
            <input placeholder="Phone Number" @bind="phoneNumber" />
            <input type="date" @bind="dateOfBirth" />
            <select @bind="gender">
                <option value="">Select Gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
            </select>

            <div class="terms-container">
                <input type="checkbox" id="terms" @bind="agreeToTerms" />
                <label for="terms">
                    I agree to the 
                    <span class="terms-link" @onclick="() => showTerms = true" style="cursor:pointer;color:blue">
                        Terms & Conditions and Privacy Policy
                    </span>
                </label>
            </div>

            @if (showTerms)
            {
                <div class="terms-popup">
                    <b>Terms & Conditions</b>
                    <p>
                        By creating an account and using the MindNest application, 
                        you agree to the following terms and conditions. MindNest is a 
                        personal mental-wellbeing and journaling application designed 
                        for educational and personal use only. All data entered into the application,
                        including personal details and journal entries, is stored locally on the 
                        userâ€™s device and is not shared with any third parties. The application does
                        not provide medical, psychological, or professional health advice, and should 
                        not be used as a substitute for professional consultation. Users are responsible
                        for maintaining the confidentiality of their login credentials. The developers 
                        of MindNest are not responsible for any data loss, emotional distress, 
                        or damages arising from the use or inability to use the application. 
                        Continued use of the application indicates acceptance of these terms.
                    </p>
                    <button @onclick="() => showTerms = false">Close</button>
                </div>
            }

            <p class="error">@message</p>

            <button class="btn-primary" @onclick="Signup" disabled="@(agreeToTerms == false)">
                Create Account
            </button>

            <div class="switch">
                Already have an account? <span @onclick="GoToLogin" style="cursor:pointer;color:blue">Login</span>
            </div>
        </div>
    </div>
</div>

@code {
    private string fullName = "";
    private string email = "";
    private string password = "";
    private string phoneNumber = "";
    private DateTime? dateOfBirth;
    private string gender = "";

    private bool agreeToTerms = false;
    private bool showTerms = false;
    private string message = "";

    private async Task Signup()
    {
        message = "";

        if (string.IsNullOrWhiteSpace(fullName) ||
            string.IsNullOrWhiteSpace(email) ||
            string.IsNullOrWhiteSpace(password) ||
            string.IsNullOrWhiteSpace(phoneNumber) ||
            dateOfBirth == null ||
            string.IsNullOrWhiteSpace(gender))
        {
            message = "Please fill all the required fields.";
            return;
        }

        if (!agreeToTerms)
        {
            message = "In order to proceed, please agree to the Terms & Conditions.";
            return;
        }

        var existingUser = await Db.GetUserByEmailAsync(email);
        if (existingUser != null)
        {
            message = "User already exists with the entered email, please log in.";
            return;
        }

        var user = new MindNestApp.Models.User
        {
            FullName = fullName,
            Email = email,
            Password = password,
            PhoneNumber = phoneNumber,
            DateOfBirth = dateOfBirth.Value,
            Gender = gender
        };

        await Db.AddUserAsync(user);

        message = "Account created successfully. Redirecting to login...";
        await Task.Delay(1500);
        Navigation.NavigateTo("/login", true);
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }
}
