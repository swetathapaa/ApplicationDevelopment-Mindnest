@page "/dashboard"
@inject SQLiteService Db
@inject NavigationManager Navigation
@inject AuthStateService Auth
@inject ThemeService Theme

<PageTitle>Dashboard</PageTitle>

@if (Auth.CurrentUser == null)
{
Navigation.NavigateTo("/login", true);
return;
}

<div class="dashboard-container" style="background:@Theme.BackgroundColor; color:@Theme.TextColor; min-height:100vh;">
    <!-- Greeting -->
    <div class="greeting">
        <h2>Good morning, @userName!</h2>
        <p>Today is @today.ToString("dddd, MMMM dd, yyyy")</p>
        <h4>How are you feeling today?</h4>
    </div>

    <!-- Top Stats Cards -->
    <div class="top-cards">
        <div class="card">
            <h3>Current Streak</h3>
            <p>@currentStreak day(s)</p>
        </div>
        <div class="card @(todaysEntry != null ? "highlight" : "")">
            <h3>Today's Mood</h3>
            <p>@(todaysEntry?.PrimaryMood ?? "No entry today")</p>
        </div>
        <div class="card">
            <h3>Recent Entries</h3>
            <p>@recentEntries.Count entry(s)</p>
        </div>
    </div>

    <!-- Main Actions -->
    <div class="main-actions">
        <div class="action-card" @onclick="GoToWriteJournal">
            <h3>Start Writing</h3>
            <p>Capture your thoughts and feelings today</p>
        </div>
        <div class="side-actions">
            <div class="action-card small" @onclick="GoToCalendar">
                <h3>Calendar</h3>
            </div>
            <div class="action-card small" @onclick="GoToAnalytics">
                <h3>Analytics</h3>
            </div>
        </div>
    </div>

    <!-- Recent Entries -->
    <div class="recent-entries">
        <h3>Recent Entries</h3>
        @if (recentEntries.Any())
        {
        <div class="entries-grid">
            @foreach (var entry in recentEntries)
            {
            <div class="entry-card">
                <div class="entry-header">
                    <b>@(!string.IsNullOrEmpty(entry.Category) ? entry.Category : "Untitled")</b>
                    <span class="word-count">@((entry.Content?.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length) ?? 0) words</span>
                </div>
                <div class="entry-date">@entry.CreatedAt.ToString("dddd, MMMM dd, yyyy")</div>
                <div class="entry-content">
                    @(!string.IsNullOrEmpty(entry.Content) && entry.Content.Length > 150
                    ? entry.Content.Substring(0, 150) + "..."
                    : entry.Content ?? "")
                </div>
                @if (!string.IsNullOrWhiteSpace(entry.Tags))
                {
                <div class="entry-tags">
                    @foreach (var tag in entry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                    {
                    <span class="tag">@tag.Trim()</span>
                    }
                </div>
                }
            </div>
            }
        </div>
        }
        else
        {
        <p>No recent entries.</p>
        }
    </div>
</div>

@code {
private string userEmail = "";
private string userName = "";
private DateTime today = DateTime.Today;

private int currentStreak = 0;
private JournalEntry? todaysEntry;
private List<JournalEntry> recentEntries = new();

protected override async Task OnInitializedAsync()
{
Theme.OnThemeChanged += StateHasChanged;

var user = Auth.CurrentUser;
if (user == null) return;

userEmail = user.Email;
userName = string.IsNullOrWhiteSpace(user.FullName) ? "User" : user.FullName;

// Load all entries
var allEntries = await Db.GetEntriesAsync(userEmail);
allEntries = allEntries.OrderByDescending(e => e.CreatedAtTicks).ToList();

todaysEntry = allEntries.FirstOrDefault(e => e.CreatedAt.Date == today);

recentEntries = allEntries.Take(3).ToList();

currentStreak = CalculateStreak(allEntries);
}

private int CalculateStreak(List<JournalEntry> entries)
{
int streak = 0;
DateTime day = today;
var datesSet = entries.Select(e => e.CreatedAt.Date).ToHashSet();

while (datesSet.Contains(day))
{
streak++;
day = day.AddDays(-1);
}
return streak;
}

// Navigation helpers
private void GoToWriteJournal() => Navigation.NavigateTo("/write-journal");
private void GoToCalendar() => Navigation.NavigateTo("/calendar");
private void GoToAnalytics() => Navigation.NavigateTo("/analytics");
}
