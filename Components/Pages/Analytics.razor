@page "/analytics"
@inject MindNestApp.Services.SQLiteService Db
@inject MindNestApp.Services.AuthStateService Auth
@inject NavigationManager Navigation
@inject ThemeService Theme
@inject IJSRuntime JS

<h2 style="margin-bottom:20px; color:@Theme.TextColor;">Analytics</h2>
<p style="color:@Theme.SecondaryTextColor; margin-bottom:20px;">Insights from your journaling journey</p>

<div class="analytics-content">

@if (!isLoaded)
{
    <p>Loading analytics...</p>
}
else
{
    <!-- Streaks -->
    <div class="streaks-container">
        <div class="streak-card">
            <h3>@CurrentStreak</h3>
            <p>Current Streak (days)</p>
        </div>
        <div class="streak-card">
            <h3>@LongestStreak</h3>
            <p>Longest Streak (days)</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-container">
        <div class="stat-card">
            <h3>@TotalEntries</h3>
            <p>Total Entries</p>
            <div class="progress-bar teal" style="width:@(Math.Min(100, TotalEntries * 10))%;"></div>
        </div>

        <div class="stat-card">
            <h3>@AverageWords</h3>
            <p>Avg Words/Entry</p>
            <div class="progress-bar coral" style="width:@(Math.Min(100, AverageWords * 5))%;"></div>
        </div>

        <div class="stat-card">
            <h3>@MostUsedMood</h3>
            <p>Most Used Mood</p>
            <div class="progress-bar mustard" style="width:100%;"></div>
        </div>

        <div class="stat-card">
            <h3>@MostUsedTag</h3>
            <p>Most Used Tag</p>
            <div class="progress-bar terracotta" style="width:100%;"></div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-container">
        <div class="chart-card">
            <h4>Mood Distribution</h4>
            <canvas id="moodChart"></canvas>
        </div>

        <div class="chart-card">
            <h4>Most Used Tags</h4>
            <canvas id="tagChart"></canvas>
        </div>
    </div>
}

</div> <!-- analytics-content -->

<style>
.analytics-content {
    padding-top: 30px; /* Adds top spacing for page */
}

/* Streaks */
.streaks-container {
    display:flex;
    gap:20px;
    flex-wrap:wrap;
    margin-bottom:30px;
}

.streak-card {
    flex:1;
    min-width:150px;
    background:@Theme.CardBackground;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 14px rgba(0,0,0,0.08);
    text-align:center;
    color:@Theme.TextColor;
    transition:0.2s;
    box-sizing:border-box;
}

.streak-card:hover {
    transform:translateY(-3px);
    box-shadow:0 8px 20px rgba(0,0,0,0.12);
}

.streak-card h3 {
    margin:0;
    font-size:1.8rem;
    color:@Theme.TextColor;
}

.streak-card p {
    margin-top:5px;
    font-size:0.95rem;
    color:@Theme.SecondaryTextColor;
}

/* Stats Cards */
.stats-container {
    display:flex;
    flex-wrap:wrap;
    gap:20px;
    margin-bottom:40px;
}

.stat-card {
    flex:1;
    min-width:150px;
    background:@Theme.CardBackground;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 14px rgba(0,0,0,0.08);
    text-align:center;
    position:relative; /* no longer needed for bar */
    color:@Theme.TextColor;
    transition:0.2s;
    box-sizing:border-box;

    display: flex;
    flex-direction: column;  /* stack content vertically */
    justify-content: flex-start;
}


.stat-card h3 {
    margin:0;
    font-size:1.8rem;
    color:@Theme.TextColor;
}

.stat-card p {
    margin-top:5px;
    font-size:0.95rem;
    color:@Theme.SecondaryTextColor;
}
.progress-bar {
    height:6px;
    border-radius:3px;
    margin-top:12px; /* spacing below text */
    width: 100%; /* always full width inside card */
    box-sizing: border-box;
    position: static; /* remove absolute positioning */
}
/* Progress Bar Colors */
.progress-bar.teal { background:#4FA9A1; }
.progress-bar.coral { background:#FF7F50; }
.progress-bar.mustard { background:#E6C85E; }
.progress-bar.terracotta { background:#D45D5D; }

/* Charts */
.charts-container {
    display:flex;
    flex-wrap:wrap;
    gap:30px;
}

.chart-card {
    flex:1;
    min-width:300px;
    max-width:600px;
    background:@Theme.CardBackground;
    border-radius:12px;
    padding:20px;
    box-shadow:0 4px 14px rgba(0,0,0,0.08);
    color:@Theme.TextColor;
}

.chart-card h4 {
    margin-bottom:15px;
    color:@Theme.TextColor;
}

canvas {
    width:100% !important;
    height:300px !important;
}

/* Responsive */
@@media (max-width:768px) {
    .streaks-container, .stats-container, .charts-container {
        flex-direction:column;
    }

    .streak-card, .stat-card, .chart-card {
        width:100%;
    }
}
</style>

@code {
    private bool isLoaded = false;
    private bool chartsRendered = false;

    private int TotalEntries;
    private int AverageWords;
    private string MostUsedMood = "-";
    private string MostUsedTag = "-";

    private int CurrentStreak = 0;
    private int LongestStreak = 0;

    private string[] moodLabels = Array.Empty<string>();
    private double[] moodValues = Array.Empty<double>();

    private string[] tagLabels = Array.Empty<string>();
    private double[] tagValues = Array.Empty<double>();

    protected override async Task OnInitializedAsync()
    {
        if (Auth.CurrentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var email = Auth.CurrentUser.Email;
        var entries = (await Db.GetEntriesAsync(email))
                      .OrderByDescending(e => e.CreatedAt)
                      .ToList();

        TotalEntries = entries.Count;

        AverageWords = TotalEntries > 0
            ? (int)Math.Round(entries.Average(e => e.Content.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length))
            : 0;

        MostUsedMood = entries
            .Where(e => !string.IsNullOrWhiteSpace(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood)
            .OrderByDescending(g => g.Count())
            .Select(g => g.Key)
            .FirstOrDefault() ?? "-";

        var tagCounts = new Dictionary<string, int>();
        foreach (var entry in entries)
        {
            if (string.IsNullOrWhiteSpace(entry.Tags)) continue;
            foreach (var tag in entry.Tags.Split(','))
            {
                var clean = tag.Trim();
                if (!tagCounts.ContainsKey(clean)) tagCounts[clean] = 0;
                tagCounts[clean]++;
            }
        }

        MostUsedTag = tagCounts.OrderByDescending(t => t.Value).Select(t => t.Key).FirstOrDefault() ?? "-";

        // Calculate streaks
        var dates = entries.Select(e => e.CreatedAt.Date).Distinct().OrderBy(d => d).ToList();
        CurrentStreak = CalculateCurrentStreak(dates);
        LongestStreak = CalculateLongestStreak(dates);

        // Prepare chart arrays
        var moodGroups = entries
            .Where(e => !string.IsNullOrWhiteSpace(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood)
            .Select(g => new { Mood = g.Key, Count = g.Count() })
            .ToList();

        moodLabels = moodGroups.Select(g => g.Mood).ToArray();
        moodValues = moodGroups.Select(g => (double)g.Count).ToArray();

        var topTags = tagCounts.OrderByDescending(t => t.Value).Take(6).ToList();
        tagLabels = topTags.Select(t => t.Key).ToArray();
        tagValues = topTags.Select(t => (double)t.Value).ToArray();

        isLoaded = true;
    }

    private int CalculateCurrentStreak(List<DateTime> dates)
    {
        int streak = 0;
        var today = DateTime.Today;
        while (dates.Contains(today))
        {
            streak++;
            today = today.AddDays(-1);
        }
        return streak;
    }

    private int CalculateLongestStreak(List<DateTime> dates)
    {
        if (!dates.Any()) return 0;

        int longest = 1, current = 1;
        for (int i = 1; i < dates.Count; i++)
        {
            if ((dates[i] - dates[i - 1]).Days == 1)
                current++;
            else
                current = 1;
            if (current > longest)
                longest = current;
        }
        return longest;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && isLoaded && !chartsRendered)
        {
            chartsRendered = true;
            await Task.Delay(150);
            await JS.InvokeVoidAsync("renderAnalyticsCharts", moodLabels, moodValues, tagLabels, tagValues);
        }
    }
}
