@page "/write-journal"
@inject SQLiteService Db
@inject NavigationManager Navigation
@inject AuthStateService Auth
@using Microsoft.AspNetCore.Components.Web
@using System.Web

<h2>@(IsEditMode ? "Edit Journal" : "Write Your Journal")</h2>

@if (Auth.CurrentUser == null)
{
    Navigation.NavigateTo("/login", true);
    return;
}

@if (!string.IsNullOrEmpty(Error))
{
    <p class="error-text">@Error</p>
}

<!-- PRIMARY MOOD -->
<div class="section">
    <label><b>Primary Mood *</b></label>
    <div class="pill-group">
        @foreach (var mood in PrimaryMoods)
        {
            <button class="pill @(PrimaryMood == mood ? "active" : "")"
                    @onclick="() => PrimaryMood = mood">
                @mood
            </button>
        }
    </div>
</div>

<!-- SECONDARY MOODS -->
<div class="section">
    <label><b>Secondary Moods (max 2)</b></label>
    <div class="pill-group">
        @foreach (var mood in SecondaryMoods)
        {
            <button class="pill @(SelectedSecondary.Contains(mood) ? "active" : "")"
                    @onclick="() => ToggleSecondaryMood(mood)">
                @mood
            </button>
        }
    </div>
</div>

<!-- CATEGORY -->
<div class="section">
    <label><b>Category</b></label>
    <div class="pill-group">
        @foreach (var cat in Categories)
        {
            <button class="pill @(Category == cat ? "active" : "")"
                    @onclick="() => Category = cat">
                @cat
            </button>
        }
    </div>
</div>

<!-- TAGS -->
<div class="section">
    <label><b>Tags (max 7)</b></label>

    <div class="tags-wrap">
        @foreach (var tag in UserTags)
        {
            <span class="tag @(SelectedTags.Contains(tag) ? "selected" : "")"
                  @onclick="() => ToggleTag(tag)">
                @tag
            </span>
        }
    </div>

    @if (SelectedTags.Count < 7)
    {
        <input class="tag-input"
               placeholder="Add custom tag & press Enter"
               @bind="NewTagInput"
               @onkeydown="HandleTagInput" />
    }
</div>

<!-- CONTENT -->
<div class="section">
    <label><b>Journal Entry</b></label>
    <textarea class="journal-box"
              rows="10"
              @bind="Content"></textarea>
</div>

<button class="save-btn" @onclick="SaveEntry">
    @(IsEditMode ? "Update Journal" : "Save Journal")
</button>

<style>
    h2 {
        margin-bottom: 1rem;
    }

    .section {
        margin-bottom: 1.5rem;
    }

    .pill-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .pill {
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        border: 1px solid #ccc;
        background: #f5f5f2;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .pill.active {
        background: #e8e3dc;
        border-color: #999;
        font-weight: 600;
    }

    .tags-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .tag {
        padding: 0.35rem 0.75rem;
        border-radius: 14px;
        background: #efede9;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .tag.selected {
        background: #d9d4cc;
        font-weight: 600;
    }

    .tag-input {
        margin-top: 0.6rem;
        width: 100%;
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .journal-box {
        width: 100%;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #ccc;
    }

    .save-btn {
        padding: 0.6rem 1.4rem;
        border-radius: 8px;
        border: none;
        background: #3b3b3b;
        color: white;
        cursor: pointer;
    }

    .error-text {
        color: #b00020;
        margin-bottom: 1rem;
    }
</style>

@code {

    // ---------- STATE ----------
    private string PrimaryMood = "";
    private List<string> SelectedSecondary = new();
    private string Category = "";
    private string Content = "";
    private string Error = "";

    private List<string> SelectedTags = new();
    private List<string> UserTags = new();
    private string NewTagInput = "";

    private string UserEmail = "";
    private JournalEntry? CurrentEntry;

    private bool IsEditMode => CurrentEntry != null;

    // ---------- EXPANDED MOODS ----------
    private readonly List<string> PrimaryMoods = new()
    {
        "Calm", "Happy", "Energetic", "Content",
        "Sad", "Anxious", "Irritated", "Overwhelmed",
        "Low Energy", "Confused", "Numb"
    };

    private readonly List<string> SecondaryMoods = new()
    {
        "Motivated", "Hopeful", "Grateful", "Restless",
        "Tired", "Lonely", "Self-Critical", "Guilty",
        "Frustrated", "Detached"
    };

    private readonly List<string> Categories = new()
    {
        "Personal", "Academic", "Work",
        "Health", "Relationships", "Self-Growth"
    };

    // ---------- INIT ----------
    protected override async Task OnInitializedAsync()
    {
        if (Auth.CurrentUser == null) return;

        UserEmail = Auth.CurrentUser.Email;
        UserTags = await Db.GetUserTagsAsync(UserEmail);

        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);

        if (int.TryParse(query["editId"], out int editId))
        {
            CurrentEntry = await Db.GetEntryByIdAsync(editId);
        }

        if (CurrentEntry != null)
        {
            PrimaryMood = CurrentEntry.PrimaryMood;
            SelectedSecondary = CurrentEntry.SecondaryMoods?.Split(',').ToList() ?? new();
            Category = CurrentEntry.Category;
            SelectedTags = CurrentEntry.Tags?.Split(',').ToList() ?? new();
            Content = CurrentEntry.Content;
        }
    }

    // ---------- TAG LOGIC ----------
    private void ToggleTag(string tag)
    {
        if (SelectedTags.Contains(tag))
            SelectedTags.Remove(tag);
        else if (SelectedTags.Count < 7)
            SelectedTags.Add(tag);
    }

    private async Task HandleTagInput(KeyboardEventArgs e)
    {
        if (e.Key != "Enter") return;

        var tag = NewTagInput.Trim();
        if (string.IsNullOrWhiteSpace(tag)) return;

        if (!UserTags.Contains(tag) && UserTags.Count < 7)
        {
            await Db.AddUserTagAsync(UserEmail, tag);
            UserTags.Add(tag);
        }

        ToggleTag(tag);
        NewTagInput = "";
    }

    // ---------- SECONDARY MOOD ----------
    private void ToggleSecondaryMood(string mood)
    {
        if (SelectedSecondary.Contains(mood))
            SelectedSecondary.Remove(mood);
        else if (SelectedSecondary.Count < 2)
            SelectedSecondary.Add(mood);
    }

    // ---------- SAVE ----------
    private async Task SaveEntry()
    {
        if (string.IsNullOrWhiteSpace(PrimaryMood))
        {
            Error = "Primary mood is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Content))
        {
            Error = "Journal content cannot be empty.";
            return;
        }

        var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();

        if (CurrentEntry == null)
        {
            CurrentEntry = new JournalEntry
            {
                UserEmail = UserEmail,
                Content = Content,
                PrimaryMood = PrimaryMood,
                SecondaryMoods = string.Join(",", SelectedSecondary),
                Category = Category,
                Tags = string.Join(",", SelectedTags),
                CreatedAtTicks = now,
                UpdatedAtTicks = now
            };

            await Db.AddEntryAsync(CurrentEntry);
        }
        else
        {
            CurrentEntry.Content = Content;
            CurrentEntry.PrimaryMood = PrimaryMood;
            CurrentEntry.SecondaryMoods = string.Join(",", SelectedSecondary);
            CurrentEntry.Category = Category;
            CurrentEntry.Tags = string.Join(",", SelectedTags);
            CurrentEntry.UpdatedAtTicks = now;

            await Db.UpdateEntryAsync(CurrentEntry);
        }

        Navigation.NavigateTo("/journal-history");
    }
}
