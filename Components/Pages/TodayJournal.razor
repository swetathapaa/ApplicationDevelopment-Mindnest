@page "/write-journal"
@page "/write-journal/edit"
@page "/write-journal/edit/{EntryId:int}"

@inject SQLiteService Db
@inject NavigationManager Navigation
@inject AuthStateService Auth
@inject IJSRuntime JSRuntime
@inject ThemeService Theme
@using Microsoft.AspNetCore.Components.Web

<div class="journal-page">

    @if (Auth.CurrentUser == null)
    {
        Navigation.NavigateTo("/login", true);
        return;
    }

    <h2>@(IsEditMode ? "Edit Today's Journal" : "Write Today's Journal")</h2>

    @if (!string.IsNullOrEmpty(Error))
    {
        <p class="error-text">@Error</p>
    }

    <div class="journal-layout">

        <!-- LEFT: Editor -->
        <section class="editor-section">

            <!-- Toolbar Card -->
            <div class="editor-card toolbar-card">
                <div class="rich-text-toolbar">
                    <button class="toolbar-btn" @onclick='() => FormatText("bold")'><strong>B</strong></button>
                    <button class="toolbar-btn" @onclick='() => FormatText("italic")'><em>I</em></button>
                    <button class="toolbar-btn" @onclick='() => FormatText("underline")'><u>U</u></button>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn" @onclick='() => FormatText("insertUnorderedList")'>&bull;</button>
                    <button class="toolbar-btn" @onclick='() => FormatText("insertOrderedList")'>1.</button>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn" @onclick='() => FormatText("formatBlock","h2")'>H</button>
                </div>
            </div>

            <!-- Editor Card -->
            <div class="editor-card editor-area-card">
                <div class="rich-text-editor"
                     contenteditable="true"
                     @ref="editorRef"
                     @oninput="OnContentChanged"
                     data-placeholder="Write your journal here..."
                     style="background:@Theme.CardBackground; color:@Theme.TextColor;">
                </div>

                <button class="save-btn" @onclick="SaveEntry">
                    @(IsEditMode ? "Update Journal" : "Save Journal")
                </button>
            </div>

        </section>

        <!-- RIGHT: Meta Section -->
        <section class="meta-section">

            <!-- Primary Mood -->
            <div class="meta-card">
                <label><b>Primary Mood *</b></label>
                
                <!-- Positive Moods -->
                <div class="mood-category-label">Positive</div>
                <div class="pill-group">
                    @foreach (var mood in PositiveMoods)
                    {
                        <button class="pill mood-positive @(PrimaryMood == mood ? "active" : "")"
                                @onclick="() => PrimaryMood = mood">
                            @mood
                        </button>
                    }
                </div>

                <!-- Neutral Moods -->
                <div class="mood-category-label">Neutral</div>
                <div class="pill-group">
                    @foreach (var mood in NeutralMoods)
                    {
                        <button class="pill mood-neutral @(PrimaryMood == mood ? "active" : "")"
                                @onclick="() => PrimaryMood = mood">
                            @mood
                        </button>
                    }
                </div>

                <!-- Negative Moods -->
                <div class="mood-category-label">Negative</div>
                <div class="pill-group">
                    @foreach (var mood in NegativeMoods)
                    {
                        <button class="pill mood-negative @(PrimaryMood == mood ? "active" : "")"
                                @onclick="() => PrimaryMood = mood">
                            @mood
                        </button>
                    }
                </div>
            </div>

            <!-- Secondary Moods -->
            <div class="meta-card">
                <label><b>Secondary Moods (max 2)</b></label>
                
                <!-- Positive Secondary -->
                <div class="mood-category-label">Positive</div>
                <div class="pill-group">
                    @foreach (var mood in PositiveMoods)
                    {
                        <button class="pill mood-positive @(SelectedSecondary.Contains(mood) ? "active" : "")"
                                @onclick="() => ToggleSecondaryMood(mood)">
                            @mood
                        </button>
                    }
                </div>

                <!-- Neutral Secondary -->
                <div class="mood-category-label">Neutral</div>
                <div class="pill-group">
                    @foreach (var mood in NeutralMoods)
                    {
                        <button class="pill mood-neutral @(SelectedSecondary.Contains(mood) ? "active" : "")"
                                @onclick="() => ToggleSecondaryMood(mood)">
                            @mood
                        </button>
                    }
                </div>

                <!-- Negative Secondary -->
                <div class="mood-category-label">Negative</div>
                <div class="pill-group">
                    @foreach (var mood in NegativeMoods)
                    {
                        <button class="pill mood-negative @(SelectedSecondary.Contains(mood) ? "active" : "")"
                                @onclick="() => ToggleSecondaryMood(mood)">
                            @mood
                        </button>
                    }
                </div>
            </div>

            <!-- Category -->
            <div class="meta-card">
                <label><b>Category</b></label>
                <div class="pill-group">
                    @foreach (var cat in Categories)
                    {
                        <button class="pill @(Category == cat ? "active" : "")"
                                @onclick="() => Category = cat">
                            @cat
                        </button>
                    }
                </div>
            </div>

            <!-- Tags -->
            <div class="meta-card">
                <label><b>Tags (Optional - max 7)</b></label>
                
                <!-- Pre-built Tags -->
                <div class="tags-section-label">Pre-built Tags</div>
                <div class="tags-wrap tags-prebuilt">
                    @foreach (var tag in PrebuiltTags)
                    {
                        <span class="tag @(SelectedTags.Contains(tag) ? "selected" : "")" @onclick="() => ToggleTag(tag)">
                            <span class="tag-text">@tag</span>
                        </span>
                    }
                </div>

                @if (CustomUserTags.Any())
                {
                    <!-- Custom Tags -->
                    <div class="tags-section-label">Your Custom Tags</div>
                    <div class="tags-wrap tags-custom">
                        @foreach (var tag in CustomUserTags)
                        {
                            <span class="tag @(SelectedTags.Contains(tag) ? "selected" : "")" @onclick="() => ToggleTag(tag)">
                                <span class="tag-text">@tag</span>
                                <button class="remove-tag"
                                        type="button"
                                        @onclick="@(() => DeleteCustomTag(tag))"
                                        @onclick:stopPropagation="true">
                                    Ã—
                                </button>
                            </span>
                        }
                    </div>
                }

                @if (SelectedTags.Count < 7)
                {
                    <input class="tag-input"
                           placeholder="Add custom tag & press Enter"
                           @bind="NewTagInput"
                           @onkeydown="HandleTagInput" />
                }
            </div>

        </section>
    </div>
</div>

<style>
/* ===== Your Existing CSS (unchanged) ===== */
.journal-page { max-width: 1200px; margin:auto; padding:25px; min-height:100vh; font-family:'Inter',sans-serif; background:@Theme.BackgroundColor; color:@Theme.TextColor; }
h2 { margin-bottom:20px; color:@Theme.TextColor; }
.error-text { color:#D45D5D; margin-bottom:15px; }
.journal-layout { display:flex; gap:20px; flex-wrap:wrap; }
.editor-section { flex:2 1 600px; display:flex; flex-direction:column; }
.editor-card { background:@Theme.CardBackground; padding:15px 20px; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
.toolbar-card { margin-bottom:10px; display:flex; justify-content:flex-start; }
.editor-area-card { display:flex; flex-direction:column; gap:10px; }
.rich-text-toolbar { display:flex; gap:8px; }
.toolbar-btn { padding:6px 12px; border-radius:8px; border:none; background:#f5f5f5; color:#333; cursor:pointer; font-weight:bold; }
.toolbar-btn:hover { background:#e0e0e0; }
.toolbar-separator { width:2px; background:#ccc; margin:0 5px; }
.rich-text-editor { min-height:280px; padding:12px; border-radius:10px; outline:none; font-size:0.95rem; border:1px solid #ddd; background:#fafafa; }
.rich-text-editor:empty:before { content: attr(data-placeholder); color:#aaa; }
.save-btn { margin-top:10px; padding:8px 16px; border-radius:10px; border:none; font-weight:bold; background:@Theme.ButtonBackground; color:@Theme.ButtonText; cursor:pointer; }
.save-btn:hover { opacity:0.85; }
.meta-section { flex:1 1 300px; display:flex; flex-direction:column; gap:15px; max-height:calc(100vh - 100px); overflow-y:auto; }
.meta-card { background:@Theme.CardBackground; padding:15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
.pill-group { display:flex; flex-wrap:wrap; gap:6px; margin-top:5px; margin-bottom:10px; }
.pill { padding:5px 12px; border-radius:12px; border:1px solid #ccc; background:#f2f2f2; cursor:pointer; font-size:0.85em; }
.pill:hover { background:#e5e5e5; }
.pill.active { background:@Theme.PillActiveBackground; color:@Theme.TextColor; font-weight:bold; }

/* Mood Category Styling */
.mood-category-label { margin-top:8px; font-size:0.8em; color:#666; font-weight:500; }
.mood-positive { border-color:#90EE90; }
.mood-positive.active { background:#90EE90 !important; color:#1a5f1a !important; }
.mood-neutral { border-color:#B0C4DE; }
.mood-neutral.active { background:#B0C4DE !important; color:#1a3a5f !important; }
.mood-negative { border-color:#FFB6B6; }
.mood-negative.active { background:#FFB6B6 !important; color:#5f1a1a !important; }

.tags-section-label { margin-top:10px; margin-bottom:5px; font-size:0.75em; color:#888; font-weight:600; text-transform:uppercase; }
.tags-wrap { display:flex; flex-wrap:wrap; gap:6px; margin-top:5px; max-height:120px; overflow-y:auto; padding:2px; }
.tags-prebuilt { max-height:100px; }
.tags-custom { max-height:80px; }
.tag { padding:4px 10px; border-radius:12px; border:1px solid #ccc; background:#eee; cursor:pointer; font-size:0.8em; position:relative; display:inline-flex; align-items:center; gap:4px; }
.tag:hover { background:#e0e0e0; }
.tag.selected { background:@Theme.PillActiveBackground; color:@Theme.TextColor; font-weight:bold; }
.tag-text { pointer-events:none; }
.remove-tag { position:absolute; top:-6px; right:-6px; border:none; background:#D45D5D; color:white; border-radius:50%; width:18px; height:18px; cursor:pointer; font-size:0.75em; line-height:16px; display:flex; align-items:center; justify-content:center; padding:0; }
.remove-tag:hover { background:#c04545; }
.tag-input { margin-top:8px; padding:6px 10px; border-radius:8px; border:1px solid #ccc; width:100%; outline:none; }
</style>

@code {
    [Parameter] public int? EntryId { get; set; }

    private ElementReference editorRef;
    private string Content = "";
    private bool IsEditMode => CurrentEntry != null;
    private string Error = "";

    private JournalEntry? CurrentEntry;

    // New Mood Categories
    private List<string> PositiveMoods = new() { "Happy", "Excited", "Relaxed", "Grateful", "Confident" };
    private List<string> NeutralMoods = new() { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" };
    private List<string> NegativeMoods = new() { "Sad", "Angry", "Stressed", "Lonely", "Anxious" };
    private string PrimaryMood = "";

    // Secondary Moods
    private List<string> SelectedSecondary = new();

    // Keep existing categories
    private List<string> Categories = new() { "Personal","Academic","Work","Health","Relationships","Self-Growth" };
    private string Category = "";

    // Pre-built Tags
    private List<string> PrebuiltTags = new() {
        "Work", "Career", "Studies", "Family", "Friends", "Relationships",
        "Health", "Fitness", "Personal Growth", "Self-care", "Hobbies", "Travel",
        "Nature", "Finance", "Spirituality", "Birthday", "Holiday", "Vacation",
        "Celebration", "Exercise", "Reading", "Writing", "Cooking", "Meditation",
        "Yoga", "Music", "Shopping", "Parenting", "Projects", "Planning", "Reflection"
    };

    private List<string> SelectedTags = new();
    private List<string> CustomUserTags = new();
    private string NewTagInput = "";

    protected override async Task OnInitializedAsync()
    {
        if (Auth.CurrentUser == null) return;

        CustomUserTags = await Db.GetUserTagsAsync(Auth.CurrentUser.Email);

        // Check if we have an EntryId parameter (editing mode)
        if (EntryId.HasValue)
        {
            CurrentEntry = await Db.GetEntryByIdAsync(EntryId.Value);

            if (CurrentEntry != null)
            {
                PrimaryMood = CurrentEntry.PrimaryMood;
                SelectedSecondary = CurrentEntry.SecondaryMoods?.Split(',').Where(s => !string.IsNullOrWhiteSpace(s)).ToList() ?? new();
                Category = CurrentEntry.Category;
                SelectedTags = CurrentEntry.Tags?.Split(',').Where(t => !string.IsNullOrWhiteSpace(t)).ToList() ?? new();
                Content = CurrentEntry.Content;

                await Task.Delay(50);
                await SetEditorContent(Content);
            }
        }
    }

    private void ToggleSecondaryMood(string mood)
    {
        if (SelectedSecondary.Contains(mood)) 
            SelectedSecondary.Remove(mood);
        else if (SelectedSecondary.Count < 2) 
            SelectedSecondary.Add(mood);
    }

    private void ToggleTag(string tag)
    {
        if (SelectedTags.Contains(tag)) SelectedTags.Remove(tag);
        else if (SelectedTags.Count < 7) SelectedTags.Add(tag);
    }

    private async Task DeleteCustomTag(string tag)
    {
        // Remove from selected tags if selected
        if (SelectedTags.Contains(tag)) 
            SelectedTags.Remove(tag);
    
        // Remove from custom tags list
        if (CustomUserTags.Contains(tag))
            CustomUserTags.Remove(tag);
    
        // Delete from database - need to get the UserCustomTag object first
        var allUserTags = await Db.GetUserCustomTagsAsync(Auth.CurrentUser.Email);
        var tagToDelete = allUserTags.FirstOrDefault(t => t.Tag == tag);
        if (tagToDelete != null)
        {
            await Db.DeleteUserCustomTagAsync(tagToDelete);
        }
    }

    private async Task HandleTagInput(KeyboardEventArgs e)
    {
        if (e.Key != "Enter") return;

        var tag = NewTagInput.Trim();
        if (string.IsNullOrWhiteSpace(tag)) return;

        if (!SelectedTags.Contains(tag) && SelectedTags.Count >= 7)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Remove a tag first to add a new one.");
            return;
        }

        // Check if tag already exists in prebuilt or custom tags
        if (PrebuiltTags.Contains(tag))
        {
            // Just toggle it if it's a prebuilt tag
            ToggleTag(tag);
        }
        else if (!CustomUserTags.Contains(tag))
        {
            // Add new custom tag to database
            await Db.AddUserTagAsync(Auth.CurrentUser.Email, tag);
            CustomUserTags.Add(tag);
            ToggleTag(tag);
        }
        else
        {
            // Custom tag already exists, just toggle it
            ToggleTag(tag);
        }

        NewTagInput = "";
    }

    private async Task FormatText(string command, string? value = null)
    {
        await JSRuntime.InvokeVoidAsync("formatText", editorRef, command, value ?? "");
        await editorRef.FocusAsync();
    }

    private async Task OnContentChanged()
        => Content = await JSRuntime.InvokeAsync<string>("getEditorContent", editorRef) ?? "";

    private async Task SetEditorContent(string html)
        => await JSRuntime.InvokeVoidAsync("setEditorContent", editorRef, html);

    private async Task SaveEntry()
    {
        if (string.IsNullOrWhiteSpace(PrimaryMood))
        {
            Error = "Primary mood is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Content))
        {
            Error = "Journal content cannot be empty.";
            return;
        }

        var nowTicks = DateTime.UtcNow.Ticks;
        var email = Auth.CurrentUser!.Email;

        if (CurrentEntry == null)
        {
            CurrentEntry = new JournalEntry
            {
                UserEmail = email,
                Content = Content,
                PrimaryMood = PrimaryMood,
                SecondaryMoods = string.Join(",", SelectedSecondary),
                Category = Category,
                Tags = string.Join(",", SelectedTags),
                CreatedAtTicks = nowTicks,
                UpdatedAtTicks = nowTicks
            };

            await Db.AddEntryAsync(CurrentEntry);
        }
        else
        {
            CurrentEntry.Content = Content;
            CurrentEntry.PrimaryMood = PrimaryMood;
            CurrentEntry.SecondaryMoods = string.Join(",", SelectedSecondary);
            CurrentEntry.Category = Category;
            CurrentEntry.Tags = string.Join(",", SelectedTags);
            CurrentEntry.UpdatedAtTicks = nowTicks;

            await Db.UpdateEntryAsync(CurrentEntry);
        }

        Navigation.NavigateTo("/dashboard");
    }
}
