@page "/journal-history"
@inject MindNestApp.Services.SQLiteService Db
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject AuthStateService Auth
@inject ThemeService Theme


<PageTitle>Journal History</PageTitle>

<div class="journal-page">

    <!-- Header -->
    <div class="journal-header">
        <h1>Journal History</h1>
        <div class="header-buttons">
            <button class="btn btn-primary" @onclick="NewEntry">New Entry</button>
            <button class="btn btn-danger" @onclick="ExportPdf">Export PDF</button>
        </div>
    </div>

    <!-- Search & Filter -->
    <div class="search-filter">
        <input type="text" placeholder="Search journals..." @bind="SearchText" @bind:event="oninput" />
        <select @bind="SelectedFilter">
            <option value="">All Categories</option>
            @foreach (var cat in categories ?? new List<string>())
            {
                <option value="@cat">@cat</option>
            }
        </select>
    </div>

    <!-- Journal Cards -->
    <div class="journal-cards">
        @if (PagedEntries != null && PagedEntries.Any())
        {
            @foreach (var entry in PagedEntries)
            {
                <div class="journal-card">
                    <div class="entry-header">
                        <span class="entry-category">@(!string.IsNullOrEmpty(entry.Category) ? entry.Category : "Untitled")</span>
                        <span class="word-count">@((entry.Content?.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length ?? 0) + " words")</span>
                    </div>

                    <div class="entry-date">
                        @entry.CreatedAt.ToString("dddd, dd MMMM yyyy")
                        @if (entry.UpdatedAt > entry.CreatedAt)
                        {
                            <span class="updated-label">(Updated)</span>
                        }
                    </div>

                    <div class="entry-content">
                        @((!string.IsNullOrEmpty(entry.Content) && entry.Content.Length > 250)
                            ? new MarkupString(entry.Content.Substring(0, 250) + "...")
                            : new MarkupString(entry.Content ?? ""))
                    </div>

                    @if (!string.IsNullOrWhiteSpace(entry.Tags))
                    {
                        <div class="entry-tags">
                            @foreach (var tag in entry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                            {
                                <span class="tag-pill">#@tag.Trim()</span>
                            }
                        </div>
                    }

                    <div class="entry-actions">
                        <button class="btn btn-primary btn-small" @onclick="() => EditEntry(entry)">Update</button>
                        <button class="btn btn-danger btn-small" @onclick="() => DeleteEntry(entry)">Delete</button>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="no-journals">No journals found.</p>
        }
    </div>

    <!-- Pagination -->
    @if (TotalPages > 1)
    {
        <div class="pagination">
            <button @onclick="PrevPage" disabled="@(_currentPage == 1)">Previous</button>
            <span>Page @_currentPage of @TotalPages</span>
            <button @onclick="NextPage" disabled="@(_currentPage == TotalPages)">Next</button>
        </div>
    }
</div>

<style>
    .journal-page {
        padding: 30px;
        max-width: 950px;
        margin: auto;
        background: @Theme.BackgroundColor;
        color: @Theme.TextColor;
        min-height: 100vh;
        font-family: 'Inter', sans-serif;
    }

    /* Header */
    .journal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .journal-header h1 {
        margin: 0;
        color: #1F2D3A;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
    }

    /* Search & Filter */
    .search-filter {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
    }

    .search-filter input,
    .search-filter select {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        outline: none;
        font-size: 0.95rem;
    }

    .search-filter select { background: white; }

    /* Buttons */
    .btn {
        padding: 6px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
    }

    .btn:hover { opacity: 0.85; }

    .btn-primary { background: @Theme.ButtonBackground; color: @Theme.ButtonText; }
    .btn-danger { background: #D45D5D; color: white; }
    .btn-small { font-size: 0.85em; padding: 4px 10px; }

    /* Journal Cards */
    .journal-cards { display: flex; flex-direction: column; gap: 20px; }

    .journal-card {
        background: @Theme.CardBackground;
        color: @Theme.TextColor;
        padding: 20px;
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .journal-card:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 24px rgba(0,0,0,0.12);
    }

    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .entry-category { font-weight: bold; font-size: 1.05em; }
    .word-count { color: @Theme.SecondaryTextColor; font-size: 0.85em; }

    .entry-date { color: @Theme.SecondaryTextColor; font-size: 0.85em; margin-bottom: 10px; }
    .updated-label { font-size: 0.75em; }

    .entry-content { margin-bottom: 10px; color: @Theme.TextColor; }

    .entry-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
    .tag-pill {
        background: @Theme.PillActiveBackground;
        color: @Theme.TextColor;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75em;
    }

    .entry-actions { display: flex; gap: 10px; }

    .no-journals { text-align: center; color: @Theme.SecondaryTextColor; }

    /* Pagination */
    .pagination {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination button {
        padding: 6px 14px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
    }

    .pagination button:disabled { opacity: 0.5; cursor: default; }
</style>

@code {
    private List<JournalEntry> allEntries = new();
    private List<JournalEntry> filteredEntries = new();
    private List<string> categories = new();

    private string searchText = "";
    private string selectedFilter = "";

    private string SearchText { get => searchText; set { searchText = value; ApplyFilter(); } }
    private string SelectedFilter { get => selectedFilter; set { selectedFilter = value; ApplyFilter(); } }

    private int _currentPage = 1;
    private int PageSize = 3;
    private int TotalPages => (int)Math.Ceiling((filteredEntries?.Count ?? 0) / (double)PageSize);
    private List<JournalEntry> PagedEntries => filteredEntries?
        .Skip((_currentPage - 1) * PageSize)
        .Take(PageSize)
        .ToList() ?? new List<JournalEntry>();

    protected override async Task OnInitializedAsync()
    {
        if (Auth.CurrentUser == null)
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        var currentUserEmail = Auth.CurrentUser.Email;
        allEntries = await Db.GetEntriesAsync(currentUserEmail);

        categories = allEntries
            .Select(e => e.Category)
            .Where(c => !string.IsNullOrEmpty(c))
            .Distinct()
            .ToList();

        ApplyFilter();
    }

    private void ApplyFilter()
    {
        filteredEntries = allEntries?
            .Where(e =>
                (string.IsNullOrEmpty(searchText) || (e.Content?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)) &&
                (string.IsNullOrEmpty(selectedFilter) || e.Category == selectedFilter))
            .ToList() ?? new List<JournalEntry>();

        _currentPage = 1;
    }

    private void PrevPage() { if (_currentPage > 1) _currentPage--; }
    private void NextPage() { if (_currentPage < TotalPages) _currentPage++; }

    private void NewEntry() => Navigation.NavigateTo("/write-journal");
    private void EditEntry(JournalEntry entry)
    {
        Navigation.NavigateTo($"/write-journal/edit/{entry.Id}");
    }

    private async Task ExportPdf()
    {
        if (filteredEntries == null || !filteredEntries.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", "No journals to export!");
            return;
        }

        try
        {
            var pdfService = new PdfExportService();
            var path = pdfService.ExportJournalsToPdf(Auth.CurrentUser.Email, filteredEntries);
            await JSRuntime.InvokeVoidAsync("alert", $"PDF exported to: {path}");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error exporting PDF: {ex.Message}");
        }
    }

    private async Task DeleteEntry(JournalEntry entry)
    {
        if (entry == null) return;

        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Delete journal '{entry.Category ?? "Untitled"}'?");
        if (confirmed)
        {
            var deleted = await Db.DeleteEntryAsync(entry);
            if (deleted > 0)
            {
                allEntries.Remove(entry);
                ApplyFilter();
            }
        }
    }
}
