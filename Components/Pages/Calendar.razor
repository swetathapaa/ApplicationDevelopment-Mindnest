@page "/calendar"
@inject SQLiteService Db
@inject NavigationManager Navigation
@inject AuthStateService Auth

<PageTitle>Journal Calendar</PageTitle>

@if (Auth.CurrentUser == null)
{
    Navigation.NavigateTo("/login", true);
    return;
}

<div class="calendar-page">

    <!-- LEFT : CALENDAR -->
    <div class="calendar-left">
        <h2>@CurrentMonth.ToString("MMMM yyyy")</h2>

        <div class="calendar-grid">
            @foreach (var dayName in DayNames)
            {
                <div class="day-header">@dayName</div>
            }

            @foreach (var cell in CalendarCells)
            {
                if (cell == null)
                {
                    <div class="day-cell empty"></div>
                }
                else
                {
                    var date = cell.Value;
                    var hasEntry = EntryMap.ContainsKey(date.Date);
                    var isPastMissed = date.Date < Today && !hasEntry;
                    var isToday = date.Date == Today;

                    <div class="day-cell
                        @(hasEntry ? "has-entry" : "")
                        @(isPastMissed ? "missed" : "")
                        @(isToday ? "today" : "")"
                         @onclick="() => OnDateClick(date)"
                         title="@GetPreview(date)">

                        <span class="day-number">@date.Day</span>

                        @if (hasEntry)
                        {
                            <span class="dot"></span>
                        }
                    </div>
                }
            }
        </div>
    </div>

    <!-- RIGHT : LEGEND + STATS -->
    <div class="calendar-right">

        <h3>Legend</h3>
        <div class="legend-item"><span class="legend green"></span> Journal written</div>
        <div class="legend-item"><span class="legend red"></span> Missed day</div>
        <div class="legend-item"><span class="legend today"></span> Today</div>
        <div class="legend-item"><span class="legend future"></span> Future day</div>

        <hr />

        <h3>This Month</h3>
        <p><b>Total days:</b> @TotalDays</p>
        <p><b>Entries written:</b> @WrittenDays</p>
        <p><b>Missed days:</b> @MissedDays</p>
        <p><b>Completion:</b> @CompletionRate%</p>

        <hr />

        <div class="tip-box">
            <b>Tip</b>
            <p>
                • Hover on a date to preview the journal<br />
                • Click a date to view or edit the full entry
            </p>
        </div>
    </div>
</div>

@code {
    DateTime Today = DateTime.Today;
    DateTime CurrentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);

    List<string> DayNames = new() { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
    List<DateTime?> CalendarCells = new();

    Dictionary<DateTime, JournalEntry> EntryMap = new();

    int TotalDays;
    int WrittenDays;
    int MissedDays;
    int CompletionRate;

    protected override async Task OnInitializedAsync()
    {
        var entries = await Db.GetEntriesAsync(Auth.CurrentUser!.Email);

        EntryMap = entries
            .GroupBy(e => e.CreatedAt.Date)
            .ToDictionary(g => g.Key, g => g.First());

        BuildCalendar();
        CalculateStats();
    }

    void BuildCalendar()
    {
        CalendarCells.Clear();

        var firstDay = CurrentMonth;
        int startOffset = (int)firstDay.DayOfWeek;
        int daysInMonth = DateTime.DaysInMonth(CurrentMonth.Year, CurrentMonth.Month);

        for (int i = 0; i < startOffset; i++)
            CalendarCells.Add(null);

        for (int day = 1; day <= daysInMonth; day++)
            CalendarCells.Add(new DateTime(CurrentMonth.Year, CurrentMonth.Month, day));
    }

    void CalculateStats()
    {
        TotalDays = DateTime.DaysInMonth(CurrentMonth.Year, CurrentMonth.Month);

        WrittenDays = EntryMap.Keys.Count(d => d.Month == CurrentMonth.Month);
        MissedDays = Enumerable.Range(1, Today.Day - 1)
            .Count(d => !EntryMap.ContainsKey(new DateTime(CurrentMonth.Year, CurrentMonth.Month, d)));

        CompletionRate = (int)((double)WrittenDays / Math.Max(1, Today.Day - 1) * 100);
    }

    void OnDateClick(DateTime date)
    {
        if (EntryMap.ContainsKey(date.Date))
            Navigation.NavigateTo($"/write-journal?editId={EntryMap[date.Date].Id}");
        else
            Navigation.NavigateTo("/write-journal");
    }

    string GetPreview(DateTime date)
    {
        if (!EntryMap.ContainsKey(date.Date)) return "No journal";

        var text = EntryMap[date.Date].Content;
        return text.Length > 80 ? text.Substring(0, 80) + "..." : text;
    }
}
