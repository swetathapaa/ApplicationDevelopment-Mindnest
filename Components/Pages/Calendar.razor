@page "/calendar"
@inject SQLiteService Db
@inject NavigationManager Navigation
@inject AuthStateService Auth
@inject ThemeService Theme

<PageTitle>Journal Calendar</PageTitle>

@if (Auth.CurrentUser == null)
{
    Navigation.NavigateTo("/login", true);
    return;
}

<div class="calendar-page" style="display:flex; flex-direction:column; gap:30px; padding:20px; background:@Theme.BackgroundColor; color:@Theme.TextColor;">

    <!-- Calendar Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <button class="btn-primary" @onclick="PrevMonth">&lt; Prev</button>
        <h2 style="margin:0; color:@Theme.TextColor;">@CurrentMonth.ToString("MMMM yyyy")</h2>
        <button class="btn-primary" @onclick="NextMonth">Next &gt;</button>
    </div>

    <div style="display:flex; gap:30px; flex-wrap:wrap;">

        <!-- LEFT : CALENDAR GRID -->
        <div style="flex:2; min-width:400px; background:@Theme.CardBackground; padding:25px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08);">
            <div class="calendar-grid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px;">

                @foreach (var dayName in DayNames)
                {
                    <div style="text-align:center; font-weight:bold; color:@Theme.SecondaryTextColor;">@dayName</div>
                }

                @foreach (var cell in CalendarCells)
                {
                    if (cell == null)
                    {
                        <div style="height:60px;"></div>
                    }
                    else
                    {
                        var date = cell.Value;
                        var hasEntry = EntryMap.ContainsKey(date.Date);
                        var isPastMissed = date.Date < Today && !hasEntry;
                        var isToday = date.Date == Today;
                        var isFuture = date.Date > Today;

                        <div style="
                            height:60px; display:flex; align-items:center; justify-content:center;
                            border-radius:10px;
                            position:relative;
                            background:@(
                                isToday ? Theme.PillActiveBackground :
                                hasEntry ? Theme.PillBackground :
                                isPastMissed ? "#FFDADA" :
                                Theme.CardBackground
                            );
                            box-shadow:0 4px 12px rgba(0,0,0,0.05);
                            transition:transform 0.2s;
                        "
                             @onmouseover="() => SetHoveredDate(date, hasEntry)"
                             @onmouseout="() => ClearHoveredDate()"
                        >

                            <span style="font-weight:bold; color:@Theme.TextColor;">@date.Day</span>

                            @if (hasEntry)
                            {
                                <span style="
                                    width:8px; height:8px; background:@Theme.ButtonBackground;
                                    border-radius:50%; position:absolute; bottom:8px;
                                "></span>
                            }

                            @if (HoveredDate.HasValue && HoveredDate.Value.Date == date.Date && !string.IsNullOrEmpty(HoveredPreview))
                            {
                                <div style="
                                    position:absolute; top:-50px; left:50%; transform:translateX(-50%);
                                    background:@Theme.CardBackground; color:@Theme.TextColor;
                                    padding:8px 12px; border-radius:6px; box-shadow:0 4px 16px rgba(0,0,0,0.2);
                                    white-space:nowrap; z-index:100;
                                    font-size:0.75rem;
                                    border:1px solid #ddd;
                                    max-width:250px;
                                    pointer-events:none;
                                ">
                                    @HoveredPreview
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        </div>

        <!-- RIGHT : STATS + LEGEND -->
        <div style="flex:1; min-width:300px; display:flex; flex-direction:column; gap:20px;">
            
            <!-- Legend Card -->
            <div style="background:@Theme.CardBackground; padding:20px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08);">
                <h3 style="color:@Theme.TextColor;">Legend</h3>
                <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                    <div><span style="display:inline-block;width:12px;height:12px;background:@Theme.ButtonBackground;border-radius:3px;margin-right:6px;"></span> Journal written</div>
                    <div><span style="display:inline-block;width:12px;height:12px;background:#D45D5D;border-radius:3px;margin-right:6px;"></span> Missed day</div>
                    <div><span style="display:inline-block;width:12px;height:12px;background:@Theme.PillActiveBackground;border-radius:3px;margin-right:6px;"></span> Today</div>
                    <div><span style="display:inline-block;width:12px;height:12px;background:@Theme.CardBackground;border:1px solid #CCC;border-radius:3px;margin-right:6px;"></span> Future day</div>
                </div>
            </div>

            <!-- Stats Card -->
            <div style="background:@Theme.CardBackground; padding:20px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); display:flex; flex-direction:column; gap:8px;">
                <h3 style="color:@Theme.TextColor;">This Month</h3>
                <p><b>Total days:</b> @TotalDays</p>
                <p><b>Entries written:</b> @WrittenDays</p>
                <p><b>Missed days:</b> @MissedDays</p>
                <p><b>Completion:</b> @CompletionRate%</p>
            </div>

            <!-- Tip Card -->
            <div style="background:@Theme.CardBackground; padding:20px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08);">
                <b>Tip</b>
                <p style="margin-top:5px; color:@Theme.SecondaryTextColor;">
                    â€¢ Hover on a date with a dot to preview the journal
                </p>
            </div>

        </div>
    </div>
</div>

@code {
    DateTime Today = DateTime.Today;
    DateTime CurrentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);

    List<string> DayNames = new() { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
    List<DateTime?> CalendarCells = new();
    Dictionary<DateTime, JournalEntry> EntryMap = new();

    int TotalDays;
    int WrittenDays;
    int MissedDays;
    int CompletionRate;

    private DateTime? HoveredDate = null;
    private string? HoveredPreview = null;

    protected override async Task OnInitializedAsync()
    {
        Theme.OnThemeChanged += StateHasChanged;

        var entries = await Db.GetEntriesAsync(Auth.CurrentUser!.Email);

        EntryMap = entries
            .GroupBy(e => e.CreatedAt.Date)
            .ToDictionary(g => g.Key, g => g.First());

        BuildCalendar();
        CalculateStats();
    }

    void BuildCalendar()
    {
        CalendarCells.Clear();

        var firstDay = CurrentMonth;
        int startOffset = (int)firstDay.DayOfWeek;
        int daysInMonth = DateTime.DaysInMonth(CurrentMonth.Year, CurrentMonth.Month);

        for (int i = 0; i < startOffset; i++)
            CalendarCells.Add(null);

        for (int day = 1; day <= daysInMonth; day++)
            CalendarCells.Add(new DateTime(CurrentMonth.Year, CurrentMonth.Month, day));
    }

    void CalculateStats()
    {
        TotalDays = DateTime.DaysInMonth(CurrentMonth.Year, CurrentMonth.Month);

        WrittenDays = EntryMap.Keys.Count(d => d.Month == CurrentMonth.Month && d.Year == CurrentMonth.Year);
        
        MissedDays = Enumerable.Range(1, Math.Min(Today.Day, TotalDays))
            .Where(d => CurrentMonth.Year == Today.Year && CurrentMonth.Month == Today.Month && d < Today.Day)
            .Count(d => !EntryMap.ContainsKey(new DateTime(CurrentMonth.Year, CurrentMonth.Month, d)));

        var eligibleDays = CurrentMonth.Year == Today.Year && CurrentMonth.Month == Today.Month 
            ? Today.Day - 1 
            : TotalDays;
        
        CompletionRate = eligibleDays == 0 ? 0 : (int)((double)WrittenDays / eligibleDays * 100);
    }

    void SetHoveredDate(DateTime date, bool hasEntry)
    {
        HoveredDate = date;
        HoveredPreview = hasEntry ? GetPreview(date) : null;
    }

    void ClearHoveredDate()
    {
        HoveredDate = null;
        HoveredPreview = null;
    }

    string GetPreview(DateTime date)
    {
        if (!EntryMap.ContainsKey(date.Date)) return string.Empty;

        var text = EntryMap[date.Date].Content;
        // Strip HTML tags for preview
        var plainText = System.Text.RegularExpressions.Regex.Replace(text ?? "", "<.*?>", "");
        return plainText.Length > 60 ? plainText.Substring(0, 60) + "..." : plainText;
    }

    void PrevMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        BuildCalendar();
        CalculateStats();
    }

    void NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        BuildCalendar();
        CalculateStats();
    }
}